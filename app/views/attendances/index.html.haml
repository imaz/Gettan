%h2 時間割

%table{:border=>'1'}
  %tr
    -@subjects.each do |subject|
      %th= subject.name
  %tr
    -@subjects.each do |subject|
      %td= '%s/%s' % [subject.attendances.count,subject.attendance]
  %tr
    -@subjects.each do |subject|
      %td
        %div.chip.subject= subject.name
%br

%table{:border=>'1'}
  %tr
    %th
    - (1..6).each do |i|
      %th{:style=>'width:50px;'}= i

  - @calendars.each_with_index do |calendar,i|
    %tr{:style=>'height:50px;'}
      %td= calendar.school_day
      - (1..6).each do |i|
        %td.slot{'data-calendar_id'=>calendar.id,'data-period'=>i}
          - attendance = calendar.attendances.select {|a| a.period == i }.first
          - if attendance
            %div.chip{'data-id'=>attendance.id}= attendance.subject.name
%br

:javascript
  function Chip(){
    this.id;
    this.calendar_id;
    this.period;
    this.set = function(slot){
      this.id = slot.find('.chip').data('id');
      this.calendar_id = slot.data('calendar_id');
      this.period = slot.data('period');
    };
    this.drop = function(slot){
      this.set(slot);
      $.ajax({
        type: 'PUT',
        url: '/attendances/'+this.id,
        data: {attendance:{period:this.period,calendar_id:this.calendar_id}},
        dataType: 'json'
      });
    };
  }
  var chip = new Chip();
  $('.chip').draggable({
    helper: 'clone'
  });
  $('.slot').droppable({
    tolerance: 'pointer',
    drop: function(ev,ui){
      if(ui.draggable.hasClass('subject')){
        ui.draggable.clone()
          .removeClass('subject')
          .draggable({helper: 'clone'})
          .appendTo(this);
      }else{
        ui.draggable.appendTo(this);
      }
      chip.drop($(this));
    }
  });

= link_to 'New Attendance', new_attendance_path
